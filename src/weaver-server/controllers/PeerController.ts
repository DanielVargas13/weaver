import axios, { AxiosResponse } from 'axios';
import * as restify from 'restify';
import * as Datastore from 'nedb';
import { ArweaveInfo } from '~/weaver-server/models';
import { getPath } from '~/shared/utils/paths';
import { WeaverServer } from '~/weaver-server/WeaverServer';

export default class PeerController {
  private server: WeaverServer;

  private peers: string[] = ['134.209.232.163:1984', '163.47.11.64:1984', '178.128.89.236:1984', '178.128.85.23:1984', '157.230.45.215:1984', '206.189.22.233:1984', '165.22.75.231:1984', '159.65.91.188:1984', '134.209.180.114:1984', '78.141.199.126:1984', '128.199.60.249:1984', '95.179.248.179:1984', '138.197.232.192:1984', '206.189.70.139:1984', '167.99.106.38:1984', '91.132.146.251:1984', '157.230.102.219:1984', '138.68.96.182:1984', '108.61.171.3:1984', '159.89.227.203:1984', '45.32.156.13:1984', '95.179.243.20:1984', '52.14.43.227:1984', '95.179.246.40:1984', '145.239.4.192:1984', '209.97.191.10:1984', '104.248.251.82:1984', '159.89.236.26:1984', '165.227.36.199:1984', '5.76.246.153:1985', '18.218.193.4:1984', '18.217.159.238:1984', '94.130.51.104:1984', '157.230.45.221:1984', '139.59.19.218:1984', '159.65.156.112:1984', '139.59.51.59:1984', '209.97.142.143:1984', '209.97.142.167:1984', '209.97.142.68:1984', '209.97.128.161:1984', '209.97.129.57:1984', '108.238.244.144:1984', '159.203.158.108:1984', '159.65.213.43:1984', '46.101.67.172:1984', '188.166.192.169:1984', '178.62.126.142:1984', '62.210.83.155:1984', '188.166.200.45:1984', '94.130.51.88:1984', '18.222.113.180:1984', '157.230.2.154:1984', '91.121.79.165:1984', '91.134.139.36:1984', '136.49.213.56:1984', '104.238.159.157:1984', '107.150.36.99:1984', '83.162.230.127:1984', '18.184.163.162:1984', '45.76.83.66:1984', '95.179.244.207:1984', '104.207.131.165:1984', '108.61.170.40:1984', '88.198.35.90:1984', '94.23.199.13:1984', '51.15.98.66:1984', '95.216.45.115:1984', '198.100.144.131:1984', '95.216.37.142:1984', '137.74.4.178:1984', '199.247.6.193:1984', '145.239.5.198:1984', '18.220.124.59:1984', '107.161.173.22:1984', '91.121.144.138:1984', '95.216.72.184:1984', '95.179.240.98:1984', '51.15.96.191:1984', '95.216.245.177:1984', '90.187.119.149:1984', '198.245.63.221:1984', '18.191.138.72:1984', '95.216.245.178:1984', '94.23.216.85:1984', '89.33.6.51:1984', '94.23.211.10:1984', '178.128.9.64:1984', '54.36.165.155:1984', '95.216.41.229:1984', '95.216.65.135:1984', '109.174.57.59:1984', '94.130.238.168:1984', '198.27.82.118:1984', '145.239.5.217:1984', '109.190.219.180:1984', '18.216.32.24:1984', '95.217.49.28:1984', '80.240.25.58:1984', '95.179.169.111:1984', '95.216.41.222:1984', '95.216.245.176:1984', '40.87.94.162:1984', '91.121.133.32:1984', '18.221.186.182:1984', '95.216.114.176:1984', '95.216.45.215:1984', '45.77.143.242:1984', '95.179.164.104:1984', '13.59.47.71:1984', '45.77.141.116:1984', '95.179.160.104:1984', '95.216.240.203:1984', '95.216.72.185:1984', '107.181.138.21:1984', '95.179.196.209:1984', '95.216.102.207:1984', '85.10.227.43:1984', '18.220.225.135:1984', '24.33.236.82:1984', '104.238.184.66:1984', '95.216.113.91:1984', '3.17.26.144:1984', '95.179.251.191:1984', '45.77.141.115:1984', '95.179.162.199:1984', '95.216.29.237:1984', '108.238.244.144:2015', '208.115.123.146:1984', '108.238.244.144:2014', '78.141.192.52:1984', '3.14.153.179:1984', '18.191.70.196:1984', '13.58.151.26:1984', '108.61.190.97:1984', '3.16.151.228:1984', '188.150.253.229:1983', '5.76.246.153:1993', '134.209.95.108:1984', '18.188.106.91:1984', '108.238.244.144:2021', '108.238.244.144:1986', '108.238.244.144:2017', '5.76.246.153:1991', '95.217.49.29:1984', '5.76.246.153:1992', '95.216.35.154:1984', '107.150.36.100:1984', '108.61.211.220:1984', '95.179.246.7:1984', '5.76.246.153:2000', '95.179.249.64:1984', '147.30.1.66:1985', '147.30.1.66:1986', '147.30.1.66:1987', '18.224.21.23:1984', '95.216.240.242:1984', '108.61.171.120:1984', '3.15.39.149:1984', '157.230.85.148:1984', '95.217.44.183:1984', '45.77.143.147:1984', '80.240.24.73:1984', '95.179.240.36:1984', '213.239.228.184:1984', '91.121.136.227:1984', '209.97.134.129:1984', '18.222.228.36:1984', '107.150.36.98:1984', '199.247.21.74:1984', '18.224.169.213:1984', '95.179.244.92:1984', '95.217.44.179:1984', '18.221.213.193:1984', '3.16.21.75:1984', '18.222.171.9:1984', '18.222.127.55:1984', '18.188.88.25:1984', '18.222.125.76:1984', '206.189.121.5:1984', '207.154.215.68:1984', '78.141.210.161:1984', '178.62.209.140:1984', '108.61.188.38:1984', '208.115.123.147:1984', '95.179.166.67:1984', '95.217.44.130:1984', '209.97.142.169:1984', '165.227.34.27:1984', '80.240.16.172:1984', '95.179.248.234:1984', '95.179.249.65:1984', '217.163.30.123:1984', '108.238.244.144:2020', '199.247.2.221:1984', '91.121.135.75:1984', '95.179.247.26:1984', '108.61.178.179:1984', '95.179.165.223:1984', '178.62.222.154:1984', '80.240.19.176:1984', '140.82.39.248:1984', '45.77.65.220:1984', '159.203.49.13:1984', '199.247.2.165:1984', '95.216.32.100:1984', '199.247.16.169:1984', '95.216.42.220:1984', '45.32.158.231:1984', '37.59.48.209:1984', '95.179.248.228:1984', '45.76.80.55:1984', '108.61.179.144:1984', '34.73.151.145:1984', '144.217.255.50:1984', '80.240.20.121:1984', '3.19.79.142:1984', '104.248.139.64:1984', '147.135.1.110:1984', '95.179.248.165:1984', '95.179.245.50:1984', '95.179.247.25:1984', '94.130.51.89:1984', '95.179.246.219:1984', '95.179.253.3:1984', '45.32.159.186:1984', '2.133.52.1:1985', '95.179.246.203:1984', '209.250.239.148:1984', '134.209.191.173:1984', '35.239.2.153:1984', '52.48.106.198:1984', '94.130.51.72:1984', '35.225.44.196:1984', '45.76.90.89:1984', '18.220.233.53:1984', '3.18.215.49:1984', '18.222.143.57:1984', '18.221.99.121:1984', '18.219.226.180:1984', '18.221.168.189:1984', '18.220.208.251:1984', '3.19.31.85:1984', '13.59.84.175:1984', '18.222.147.48:1984', '3.17.37.248:1984', '3.18.104.25:1984', '18.222.239.0:1984', '18.221.234.179:1984', '13.58.104.14:1984', '18.188.19.129:1984', '3.18.221.231:1984', '18.220.168.195:1984', '18.219.2.92:1984', '3.19.68.240:1984', '3.15.41.186:1984', '18.188.108.94:1984', '18.224.40.182:1984', '18.188.147.206:1984', '13.59.189.90:1984', '18.220.179.202:1984', '3.14.132.56:1984', '18.219.12.69:1984', '18.216.172.114:1984', '3.14.145.208:1984', '3.15.3.157:1984', '18.216.49.34:1984', '18.223.161.55:1984', '18.223.241.28:1984', '18.220.120.142:1984', '18.223.205.154:1984', '18.225.6.244:1984', '18.188.148.83:1984', '213.118.248.166:1985', '213.118.248.166:1984', '3.14.133.53:1984', '18.217.77.123:1984', '18.217.51.121:1984', '18.223.205.94:1984', '3.14.249.247:1984', '3.17.129.91:1984', '18.223.169.71:1984', '18.221.70.192:1984', '18.188.65.108:1984', '3.15.10.166:1984', '3.14.135.2:1984', '18.220.118.87:1984', '3.16.89.73:1984', '18.220.135.58:1984', '18.188.114.25:1984', '80.240.22.212:1984', '18.191.120.179:1984', '18.218.43.168:1984', '18.223.164.145:1984', '18.188.3.89:1984', '18.220.137.42:1984', '3.16.167.0:1984', '18.223.102.94:1984', '13.59.1.47:1984', '3.18.225.183:1984', '3.18.105.49:1984', '18.222.144.92:1984', '3.16.157.42:1984', '18.221.180.180:1984', '18.222.180.105:1984', '140.82.35.253:1984', '199.247.6.43:1984', '18.224.199.229:1984', '5.76.246.153:1984', '18.222.165.8:1984', '13.59.66.18:1984', '51.89.155.7:1984', '18.222.72.125:1984', '178.128.176.31:1984', '108.238.244.144:2002', '108.238.244.144:2001', '108.238.244.144:2011', '108.238.244.144:2012', '108.238.244.144:2013', '108.238.244.144:2010', '208.115.123.148:1984', '104.197.134.26:1984', '18.223.184.225:1984', '147.30.1.66:1989', '147.30.1.66:1988', '109.190.219.180:1983', '74.105.39.88:1985', '74.105.39.88:1984', '95.216.42.214:1984', '42.60.69.66:1984', '84.230.8.226:1984', '158.69.121.141:1984', '51.79.13.192:1984', '149.56.106.187:1984', '149.56.242.213:1984', '149.56.243.10:1984', '149.56.28.42:1984', '149.56.242.11:1984', '149.56.243.28:1984', '164.132.200.227:1984', '149.56.242.59:1984', '149.56.243.24:1984', '164.132.203.215:1984', '213.32.7.192:1984', '144.217.10.33:1984', '164.132.201.49:1984', '149.56.243.9:1984', '149.56.242.207:1984', '149.56.29.129:1984', '149.202.86.72:1984', '149.56.107.199:1984', '164.132.200.193:1984', '193.70.80.52:1984', '158.69.121.179:1984', '158.69.122.231:1984', '149.56.242.89:1984', '149.56.242.197:1984', '164.132.233.11:1984', '151.80.109.126:1984', '151.80.47.129:1984', '149.56.29.194:1984', '144.217.10.5:1984', '158.69.122.221:1984', '149.56.242.58:1984', '149.202.223.87:1984', '158.69.123.41:1984', '149.202.88.203:1984', '158.69.122.230:1984', '164.132.200.205:1984', '149.56.106.188:1984', '149.56.242.216:1984', '149.56.106.157:1984', '149.56.107.202:1984', '149.56.106.179:1984', '149.56.106.203:1984', '149.56.107.115:1984', '149.56.106.33:1984', '149.56.107.165:1984', '149.56.106.210:1984', '158.69.23.70:1984', '149.56.242.109:1984', '149.56.107.139:1984', '149.56.107.133:1984', '149.56.28.142:1984', '149.56.28.33:1984', '149.56.28.160:1984', '149.56.28.141:1984', '149.56.242.57:1984', '149.56.243.11:1984', '149.56.28.28:1984', '149.56.28.189:1984', '144.217.10.35:1984', '144.217.10.10:1984', '144.217.10.43:1984', '149.56.243.41:1984', '149.56.243.21:1984', '144.217.10.96:1984', '144.217.10.41:1984', '144.217.10.13:1984', '144.217.10.94:1984', '144.217.10.95:1984', '144.217.10.45:1984', '149.56.243.46:1984', '149.56.243.29:1984', '149.56.243.25:1984', '158.69.122.62:1984', '158.69.122.157:1984', '151.80.230.232:1984', '8.26.94.205:1984', '158.69.121.198:1984', '149.56.107.19:1984', '149.56.107.67:1984', '164.132.202.64:1984', '149.56.106.178:1984', '149.56.243.22:1984', '158.69.123.137:1984', '149.56.107.196:1984', '149.56.243.34:1984', '149.56.106.150:1984', '149.56.107.158:1984', '149.56.28.181:1984', '144.217.10.36:1984', '149.202.88.205:1984', '149.202.88.174:1984', '151.80.230.41:1984', '158.69.23.121:1984', '149.56.28.10:1984', '149.56.107.68:1984', '149.56.106.154:1984', '149.56.107.101:1984', '149.56.29.136:1984', '149.56.107.161:1984', '149.56.107.156:1984', '8.26.94.187:1984', '149.56.107.93:1984', '8.26.94.103:1984', '149.56.106.49:1984', '149.56.29.222:1984', '149.56.28.153:1984', '8.26.94.77:1984', '149.56.107.6:1984', '149.56.28.48:1984', '149.56.28.30:1984', '158.69.122.208:1984', '149.202.88.155:1984', '149.202.88.235:1984', '144.217.10.26:1984', '8.26.94.209:1984', '149.56.29.104:1984', '149.56.107.53:1984', '149.56.107.108:1984', '8.26.94.124:1984', '149.56.28.46:1984', '149.56.242.200:1984', '158.69.122.178:1984', '164.132.201.39:1984', '164.132.200.154:1984', '149.56.242.222:1984', '149.56.242.226:1984', '149.56.107.159:1984', '149.56.107.121:1984', '149.56.242.62:1984', '149.202.88.199:1984', '149.56.106.239:1984', '164.132.201.33:1984', '164.132.200.112:1984', '149.56.107.171:1984', '149.56.28.152:1984', '158.69.121.164:1984', '158.69.122.115:1984', '149.56.107.73:1984', '8.26.94.239:1984', '158.69.122.218:1984', '149.56.106.218:1984', '149.56.107.37:1984', '149.56.29.219:1984', '149.56.243.38:1984', '164.132.203.228:1984', '149.56.107.23:1984', '164.132.201.13:1984', '164.132.203.194:1984', '193.70.80.99:1984', '149.56.107.50:1984', '8.26.94.89:1984', '164.132.203.198:1984', '158.69.122.239:1984', '149.202.88.212:1984', '213.32.7.165:1984', '149.202.89.151:1984', '213.32.7.176:1984', '151.80.47.234:1984', '193.70.80.83:1984', '164.132.203.165:1984', '149.202.223.111:1984', '149.56.242.110:1984', '164.132.201.191:1984', '193.70.80.205:1984', '149.202.87.4:1984', '193.70.80.76:1984', '213.32.7.161:1984', '164.132.200.202:1984', '149.56.242.125:1984', '149.56.242.199:1984', '151.80.108.190:1984', '149.56.243.27:1984', '149.202.223.120:1984', '151.80.109.91:1984', '151.80.230.115:1984', '164.132.201.41:1984', '149.56.107.81:1984', '149.56.107.83:1984', '149.56.107.172:1984', '51.79.5.208:1984', '54.39.249.32:1984', '54.39.249.80:1984', '54.39.249.16:1984', '149.56.86.64:1984', '51.79.5.192:1984', '54.39.249.48:1984', '54.39.249.64:1984', '142.44.237.144:1984', '149.56.9.64:1984', '51.79.42.0:1984', '66.70.212.0:1984', '54.39.35.192:1984', '51.79.40.224:1984', '51.79.56.128:1984', '149.56.67.128:1984', '54.39.215.112:1984', '149.56.106.146:1984', '158.69.121.235:1984', '149.56.107.173:1984', '149.56.106.26:1984', '149.56.107.63:1984', '158.69.122.207:1984', '158.69.122.234:1984', '158.69.123.4:1984', '149.56.107.76:1984', '149.56.107.181:1984', '158.69.121.140:1984', '149.202.86.126:1984', '149.56.243.7:1984', '8.26.94.224:1984', '8.26.94.189:1984', '151.80.111.157:1984', '158.69.123.93:1984', '149.56.106.216:1984', '158.69.123.199:1984', '158.69.23.150:1984', '149.56.107.163:1984', '193.70.80.196:1984', '158.69.123.80:1984', '149.202.65.153:1984', '149.202.88.173:1984', '193.70.81.230:1984', '158.69.121.210:1984', '158.69.121.228:1984', '149.56.107.198:1984', '149.56.107.113:1984', '149.56.106.159:1984', '151.80.47.51:1984', '149.56.242.211:1984', '164.132.200.218:1984', '8.26.94.215:1984', '158.69.123.58:1984', '158.69.122.211:1984', '149.56.243.49:1984', '8.26.94.170:1984', '149.56.28.22:1984', '158.69.121.230:1984', '149.56.243.23:1984', '149.56.243.20:1984', '149.56.107.120:1984', '144.217.10.34:1984', '144.217.10.7:1984', '164.132.203.229:1984', '158.69.122.192:1984', '158.69.123.209:1984', '158.69.122.113:1984', '192.99.248.128:1984', '198.27.91.160:1984', '149.56.28.175:1984', '213.32.7.152:1984', '164.132.200.101:1984', '158.69.123.195:1984', '144.217.10.32:1984', '149.202.89.107:1984', '164.132.203.218:1984', '149.56.106.40:1984', '149.56.106.215:1984', '151.80.111.164:1984', '149.56.242.203:1984', '164.132.201.150:1984', '213.32.7.156:1984', '164.132.201.192:1984', '158.69.121.40:1984', '193.70.80.56:1984', '164.132.203.170:1984', '164.132.203.212:1984', '158.69.123.66:1984', '149.56.29.127:1984', '142.44.203.32:1984', '164.132.202.10:1984', '149.56.107.28:1984', '149.202.88.196:1984', '193.70.80.239:1984', '149.56.107.84:1984', '158.69.123.134:1984', '193.70.81.138:1984', '149.56.106.169:1984', '149.56.106.182:1984', '8.26.94.221:1984', '8.26.94.158:1984', '149.56.106.147:1984', '158.69.122.142:1984', '144.217.10.15:1984', '149.56.242.9:1984', '149.56.242.219:1984', '158.69.123.197:1984', '149.56.242.127:1984', '149.56.242.198:1984', '149.56.242.210:1984', '193.70.80.60:1984', '149.56.28.36:1984', '158.69.123.31:1984', '158.69.123.71:1984', '158.69.123.51:1984', '158.69.121.232:1984', '149.56.28.35:1984', '149.56.242.215:1984', '149.56.28.38:1984', '149.56.28.43:1984', '158.69.123.73:1984', '158.69.121.206:1984', '164.132.201.52:1984', '149.56.28.183:1984', '164.132.203.231:1984', '144.217.10.8:1984', '149.56.107.58:1984', '158.69.121.227:1984', '149.56.107.146:1984', '149.202.88.228:1984', '149.56.242.44:1984', '164.132.200.166:1984', '164.132.202.32:1984', '164.132.201.19:1984', '193.70.80.113:1984', '158.69.121.234:1984', '193.70.81.152:1984', '164.132.203.227:1984', '149.202.89.20:1984', '164.132.200.145:1984', '149.56.28.216:1984', '149.202.88.193:1984', '8.26.94.92:1984', '193.70.80.221:1984', '164.132.202.31:1984', '149.202.88.83:1984', '149.202.88.219:1984', '149.202.88.157:1984', '149.56.29.202:1984', '149.202.88.233:1984', '149.56.29.220:1984', '158.69.121.161:1984', '158.69.122.171:1984', '149.56.242.218:1984', '158.69.121.138:1984', '158.69.123.87:1984', '149.56.28.34:1984', '158.69.121.223:1984', '151.80.47.37:1984', '149.56.28.150:1984', '144.217.10.16:1984', '144.217.10.37:1984', '149.56.106.219:1984', '149.56.106.223:1984', '158.69.123.83:1984', '151.80.230.74:1984', '213.32.7.153:1984', '158.69.120.92:1984', '149.56.107.195:1984', '164.132.203.223:1984', '164.132.200.161:1984', '149.56.243.48:1984', '149.56.28.26:1984', '149.56.243.32:1984', '158.69.123.124:1984', '149.56.243.36:1984', '149.202.89.177:1984', '151.80.47.233:1984', '158.69.121.216:1984', '149.56.242.205:1984', '158.69.121.159:1984', '158.69.123.75:1984', '164.132.233.37:1984', '158.69.123.70:1984', '149.56.107.127:1984', '149.56.242.201:1984', '158.69.123.67:1984', '193.70.80.217:1984', '94.23.74.168:1984', '52.49.242.161:1984', '158.69.123.79:1984', '149.56.106.166:1984', '138.68.138.34:1984', '147.30.1.66:1984', '127.0.0.1:1984', '52.14.75.154:1984', '199.247.7.146:1984', '45.77.64.240:1984', '80.240.21.159:1984', '108.61.170.222:1984', '2.133.52.1:1984', '95.179.162.248:1984', '45.76.83.0:1984', '37.214.217.69:1984', '144.217.110.0:1984', '209.97.142.170:1984', '172.6.90.173:1984', '159.65.89.28:1984', '95.216.113.98:1984', '178.62.122.194:2012', '178.62.122.194:1986', '178.62.122.194:1988', '178.62.122.194:2001', '178.62.122.194:2015', '196.52.2.104:1984', '24.33.236.82:1983', '178.62.122.194:1983', '178.62.122.194:1987', '178.62.122.194:2020', '178.62.122.194:1992', '178.62.122.194:1991', '178.62.122.194:2002', '178.62.122.194:1985', '178.62.122.194:2013', '178.62.122.194:2014', '178.62.122.194:1989'];
  private activePeers: {peer: string, info: ArweaveInfo}[] = [{ peer: 'https://arweave.net', info: null }];

  private peersDB = new Datastore({
    filename: getPath('storage/arweave-peers.db'),
    autoload: true,
  });

  constructor(server: WeaverServer) {
    this.server = server;
  }

  async init() {
    return new Promise((resolve) => {
      this.peersDB.find({}, (err: any, docs: string[]) => {
        if (err) {
          console.log(err);
        } else if (docs.length) {
          this.peers = docs;
        }

        resolve();
      });
    });
  }

  /*** GET Requests ***/
  public getAllPeers() {
    return this.peers;
  }
  public getAllActivePeers() {
    return this.activePeers;
  }

  public get(req: restify.Request, res: restify.Response, next: restify.Next) {
    res.send(this.activePeers.map(p => p.peer));
    next();
  }

  /*** Getters ***/
  public getRandomPeerIndex(activated: boolean = true) {
    return Math.floor(Math.random() * (activated ? this.activePeers.length : this.peers.length));
  }
  public getPeerByIndex(index: number) {
    return this.activePeers[index];
  }
  public getPeerUrlFromIndex(index: number, activated: boolean = true): string {
    if (!activated) {
      return `http://${this.peers[index]}`;
    }
    return this.activePeers[index].peer.startsWith('http') ? this.activePeers[index].peer : `http://${this.activePeers[index].peer}`;
  }

  private async getPeerPeers(): Promise<string[]> {
    return new Promise((async resolve => {
      const randIndex = this.server.peerController.getRandomPeerIndex();
      const url = this.server.peerController.getPeerUrlFromIndex(randIndex);

      try {
        const res: AxiosResponse = await axios.get(`${url}/peers`);

        // In case of some unknown error
        if (!res.data || !res.data.length) {
          console.log(this.activePeers.length);
          this.activePeers.splice(randIndex, 1);
          return resolve(this.getPeerPeers());
        }

        resolve(res.data);
      } catch (e) {
        console.log(e, this.activePeers.length);
        console.log('- Error. Retrying.');
        this.activePeers.splice(randIndex, 1);
        return resolve(this.getPeerPeers());
      }
    }));
  }

  /*** Setters ***/

  /**
   * Even if we have hundreds of peers, we only "activate" a peer when it's up to date,
   * get at least 10 and continue looking while everything else is being done;
   * we need to cleanup all the non up to date nodes.
   */
  private async activatePeers() {
    const p: {peer: string, info: ArweaveInfo}[] = [];

    const testPeer = async () => {
      return new Promise(async (resolve) => {
        if (p.length === 10) {
          resolve();
        }

        const randIndex = this.server.peerController.getRandomPeerIndex(false);
        const url = this.getPeerUrlFromIndex(randIndex, false);

        this.server.infoController.getPeerInfo(url).then(async (peer: ArweaveInfo) => {
          if (!p.length) {
            p.push({ peer: this.peers[randIndex], info: peer });
            return resolve(testPeer());
          }

          if (peer.height > p[0].info.height) {
            // Delete any peer that is smaller
            for (let i = 0, j = p.length; i < j; i++) {
              if (p[i].info.height < peer.height) {
                p.splice(i, 1);
                i--;
              }
            }
          }
          p.push({ peer: this.peers[randIndex], info: peer });

          resolve(testPeer());
        }).catch(e => {
          this.peers.splice(randIndex, 1);
          resolve(testPeer());
        });
      });
    };

    await testPeer();
    this.activePeers = p.map(a => ({ peer: a.peer, info: a.info }));

    this.server.trigger('peers-ready');

    this.peers = await this.getPeerPeers();
    return this.activePeers;
  }

  public removePeer(index: number) {
    if (this.activePeers[index]) {
      this.activePeers.splice(index, 1);
    }

    if (!this.activePeers.length) {
      this.activePeers = [{ peer: 'https://arweave.net', info: null }];
    }
  }

  public async update() {
    await this.activatePeers();
  }
}
